generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Isolate {
  id                      String                    @id @default(uuid())
  label                   String
  sampleType              String                    // 'clinical' | 'environmental'
  phenotypeId             String?
  collectionSource        String
  patientId               String?
  environmentId           String?
  orgId                   String
  collectionSite          String
  collectionDate          DateTime
  priority                String?
  processingStatus        String?
  notes                   String?
  
  // Genome management - link to managed genome files
  genomeId                String?                   // Link to primary genome for this isolate
  
  // Audit fields
  createdBy               String?                   // User ID who created
  updatedBy               String?                   // User ID who last updated
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime                  @updatedAt
  
  // Relationships
  genome                  GenomicData?              @relation("IsolateGenome", fields: [genomeId], references: [id])
  genomicData             GenomicData[]             @relation("IsolateAnalyses")
  environment             Environment?              @relation(fields: [environmentId], references: [id])
  organization            Organization              @relation(fields: [orgId], references: [id])
  patient                 Patient?                  @relation(fields: [patientId], references: [id])
  phenotypeProfile        PhenotypeProfile?         @relation(fields: [phenotypeId], references: [id])
  treatments              IsolateTreatmentOutcome[]

  @@index([phenotypeId])
  @@index([collectionDate])
  @@index([orgId])
  @@index([patientId])
  @@index([environmentId])
  @@index([sampleType])
  @@index([genomeId])
}

model PhenotypeProfile {
  id         String    @id @default(uuid())
  species    String?
  method     String?
  testDate   DateTime?
  confidence Float?
  notes      String?
  micData    String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  isolates   Isolate[]
}

model GenomicData {
  id                              String    @id @default(uuid())
  
  // File management fields
  filename                        String
  originalFilename                String
  storagePath                     String    // Managed location in /data/genomes/
  fileSize                        Int
  fileHash                        String    @unique
  uploadDate                      DateTime  @default(now())
  
  // Validation and processing status
  validationStatus                String    @default("pending") // pending, valid, invalid
  processingStatus                String    @default("uploaded") // uploaded, validated, analyzing, completed, failed
  validationErrors                String?   // JSON array of validation issues
  
  // Assembly quality metrics (populated during upload validation)
  contigCount                     Int?
  totalLength                     Int?
  n50                            Int?
  gcContent                       Float?
  qualityMetrics                  String?   // JSON with detailed QC metrics
  
  // Analysis results (populated by pipeline)
  sequencingPlatform             String?    
  assemblyStats                  String?    // JSON
  mlstScheme                     String?
  mlstType                       String?
  mlstAlleles                    String?    // JSON
  resistanceGenes                String?    // JSON array
  virulenceGenes                 String?    // JSON array  
  plasmids                       String?    // JSON array
  speciesIdentification          String?
  speciesConfidence              Float?
  
  // Pipeline integration
  assemblyPath                   String?    // Path to processed assembly
  annotationPath                 String?    // Path to annotation files
  analysisCompleted              Boolean    @default(false)
  pipelineJobId                  String?    // Link to pipeline job
  
  // Audit fields
  uploadedBy                     String     // User who uploaded
  createdBy                      String?    // User/system who created record
  updatedBy                      String?    // User/system who updated
  notes                          String?
  createdAt                      DateTime   @default(now())
  updatedAt                      DateTime   @updatedAt
  
  // Relationships
  primaryIsolate                 Isolate[]  @relation("IsolateGenome")    // Primary genome for isolates
  analysisIsolates               Isolate[]  @relation("IsolateAnalyses")  // Analysis results for isolates

  @@index([validationStatus])
  @@index([processingStatus])
  @@index([uploadedBy])
  @@index([uploadDate])
}

model IsolateTreatmentOutcome {
  id            String    @id @default(uuid())
  isolateId     String
  antibiotic    String
  startDate     DateTime
  endDate       DateTime?
  outcome       String
  clinicalNotes String?
  createdAt     DateTime  @default(now())
  isolate       Isolate   @relation(fields: [isolateId], references: [id])

  @@index([isolateId])
  @@index([outcome])
}

model ProteinRef {
  uniprotId    String   @id
  name         String
  function     String?
  sequenceHash String   @unique
  category     String?
  updatedAt    DateTime @updatedAt
}

model Organization {
  id           String        @id @default(uuid())
  name         String
  type         String
  code         String        @unique
  isInternal   Boolean       @default(false)
  contactEmail String?
  contactPhone String?
  address      String?
  accessLevel  String        @default("viewer")
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  environments Environment[]
  isolates     Isolate[]
  patients     Patient[]
  patientAdts  PatientAdt[]
  users        User[]

  @@index([code])
}

model Patient {
  id            String       @id @default(uuid())
  dateOfBirth   DateTime?
  sex           String?
  clinicalNotes String?
  orgId         String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  isolates      Isolate[]
  organization  Organization @relation(fields: [orgId], references: [id])
  adtRecords    PatientAdt[]

  @@index([orgId])
}

model PatientAdt {
  id            String       @id @default(uuid())
  patientId     String
  orgId         String
  admitDate     DateTime
  dischargeDate DateTime?
  transferType  String?
  ward          String?
  bed           String?
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  organization  Organization @relation(fields: [orgId], references: [id])
  patient       Patient      @relation(fields: [patientId], references: [id])

  @@index([patientId])
  @@index([orgId])
}

model Environment {
  id           String       @id @default(uuid())
  siteName     String
  facilityType String?
  orgId        String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  organization Organization @relation(fields: [orgId], references: [id])
  isolates     Isolate[]

  @@index([orgId])
}

model User {
  id             String       @id @default(uuid())
  email          String       @unique
  firstName      String
  lastName       String
  orgId          String
  role           String       @default("viewer")
  permissions    String?
  isActive       Boolean      @default(true)
  authProvider   String?
  authProviderId String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([authProviderId])
}
